pipeline {
    agent none
    options {
        timeout(time: 1, unit: 'HOURS')
    }

    stages {

        stage('Checkout') {
            agent { label 'slave' }
            steps {
                git branch: 'dev',
                    credentialsId: 'github',
                    url: 'https://github.com/Sooria16/knote.git'
            }
        }

        stage('PreCheck') {
            agent { label 'slave' }
            steps {
                script {
                    env.DESTROYME = "yes"
                }
            }
        }

        stage('Terraform Destroy Plan') {
            agent { label 'slave' }
            when {
                environment name: 'DESTROYME', value: 'yes'
            }
            steps {
                script {
                    dir("terraform2/terraform/dev") {
                        sh "terraform init -no-color"
                        sh "terraform plan -destroy -no-color"
                    }
                }
            }
        }

        stage('Approval to Destroy') {
            agent { label 'slave' }
            when {
                environment name: 'DESTROYME', value: 'yes'
            }
            steps {
                script {
                    input message: 'WARNING: Destroy all Terraform resources?', ok: 'Destroy'
                }
            }
        }

        stage('Destroy Terraform') {
            agent { label 'slave' }
            when {
                environment name: 'DESTROYME', value: 'yes'
            }
            steps {
                script {
                    dir("terraform2/terraform/dev") {
                        sh "terraform destroy -auto-approve -no-color"
                    }
                }
            }
        }
    }
}

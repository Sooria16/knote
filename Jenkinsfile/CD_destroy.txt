pipeline {
    agent none

    options {
        timeout(time: 1, unit: 'HOURS')
    }

    environment {
        BUILDME = 'yes'

        NAMESPACE      = 'devproject'
        DOMAIN_NAME    = 'www.cipherworld.shop'
        HOSTED_ZONE_ID = 'Z00868963MIIUG9RNPKSN'

        AWS_DEFAULT_REGION      = 'us-west-2'
        AWS_ACCESS_KEY_ID       = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY   = credentials('aws-secret-key')
    }

    stages {

        stage('Checkout') {
            agent { label 'slave' }
            steps {
                git branch: 'dev',
                    credentialsId: 'github',
                    url: 'https://github.com/Sooria16/knote.git'
            }
        }

        stage('PreDestroy Check') {
            agent { label 'slave' }
            steps {
                script {
                    if (env.BUILDME != 'yes') {
                        error "Destroy aborted: BUILDME != yes"
                    }
                }
                echo "âš ï¸ DESTROY operation confirmed"
            }
        }

        stage('Destroy Approval') {
            agent { label 'slave' }
            steps {
                input message: 'âš ï¸ Are you sure you want to DESTROY all infrastructure?',
                      ok: 'DESTROY'
            }
        }

        stage('Test AWS Access') {
            agent { label 'slave' }
            steps {
                sh 'aws sts get-caller-identity'
            }
        }

        /* ğŸ”¥ THIS WAS MISSING ğŸ”¥ */
        stage('Configure EKS Access') {
            agent { label 'slave' }
            steps {
                sh '''
                    aws eks update-kubeconfig \
                      --region us-west-2 \
                      --name devcluster

                    kubectl get nodes
                '''
            }
        }

        stage('Delete Application & K8s Resources') {
            agent { label 'slave' }
            steps {
                sh '''
                    kubectl delete -f sun-kube-cluster/dev/multi-tier/webcon.yaml --ignore-not-found
                    kubectl delete -f sun-kube-cluster/dev/multi-tier/mongodb.yaml --ignore-not-found
                    kubectl delete -f sun-kube-cluster/dev/multi-tier/pvc.yaml --ignore-not-found
                    kubectl delete -f sun-kube-cluster/dev/multi-tier/storageclass.yaml --ignore-not-found
                    kubectl delete -f sun-kube-cluster/dev/ns.yaml --ignore-not-found
                '''
            }
        }

        stage('Delete Ingress Controller') {
            agent { label 'slave' }
            steps {
                sh 'kubectl delete -f sun-kube-cluster/dev/newIngressctrl.yaml --ignore-not-found'
            }
        }

        stage('Delete Route53 Record') {
            agent { label 'slave' }
            steps {
                sh '''
                    LB_DNS=$(aws route53 list-resource-record-sets \
                      --hosted-zone-id ${HOSTED_ZONE_ID} \
                      --query "ResourceRecordSets[?Name == '${DOMAIN_NAME}.'].ResourceRecords[0].Value" \
                      --output text)

                    if [ "$LB_DNS" = "None" ]; then
                      echo "Route53 record not found"
                      exit 0
                    fi

                    cat > route5

pipeline {
    agent none

    options {
        timeout(time: 1, unit: 'HOURS')
    }

    environment {
        // Control flag
        BUILDME = 'yes'

        // Kubernetes / App
        NAMESPACE = 'devproject'
        DOMAIN_NAME = 'www.cipherworld.shop'
        HOSTED_ZONE_ID = 'Z00868963MIIUG9RNPKSN'

        // AWS
        AWS_DEFAULT_REGION = 'us-west-2'
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')
    }

    stages {

        /* -------------------- SCM -------------------- */
        stage('Checkout') {
            agent { label 'slave' }
            steps {
                git branch: 'dev',
                    credentialsId: 'github',
                    url: 'https://github.com/Sooria16/knote.git'
            }
        }

        /* -------------------- SAFETY CHECK -------------------- */
        stage('PreDestroy Check') {
            agent { label 'slave' }
            steps {
                script {
                    if (env.BUILDME != 'yes') {
                        error "ðŸš« Destroy aborted: BUILDME is not set to yes"
                    }
                }
                echo "âš ï¸ DESTROY operation confirmed"
            }
        }

        /* -------------------- MANUAL APPROVAL -------------------- */
        stage('Destroy Approval') {
            agent { label 'slave' }
            steps {
                input message: 'âš ï¸ Are you sure you want to DESTROY all infrastructure?', ok: 'DESTROY'
            }
        }

        /* -------------------- AWS VALIDATION -------------------- */
        stage('Test AWS Access') {
            agent { label 'slave' }
            steps {
                sh 'aws sts get-caller-identity'
            }
        }

        /* -------------------- KUBERNETES CLEANUP -------------------- */
        stage('Delete Application & K8s Resources') {
            agent { label 'slave' }
            steps {
                sh '''
                    kubectl delete -f sun-kube-cluster/dev/multi-tier/webcon.yaml --ignore-not-found
                    kubectl delete -f sun-kube-cluster/dev/multi-tier/mongodb.yaml --ignore-not-found
                    kubectl delete -f sun-kube-cluster/dev/multi-tier/pvc.yaml --ignore-not-found
                    kubectl delete -f sun-kube-cluster/dev/multi-tier/storageclass.yaml --ignore-not-found
                    kubectl delete -f sun-kube-cluster/dev/ns.yaml --ignore-not-found
                '''
            }
        }

        /* -------------------- INGRESS CLEANUP -------------------- */
        stage('Delete Ingress Controller') {
            agent { label 'slave' }
            steps {
                sh 'kubectl delete -f sun-kube-cluster/dev/newIngressctrl.yaml --ignore-not-found'
            }
        }

        /* -------------------- ROUTE53 CLEANUP (OPTIONAL) -------------------- */
        stage('Delete Route53 Record') {
            agent { label 'slave' }
            steps {
                sh '''
                    LB_DNS=$(aws route53 list-resource-record-sets \
                      --hosted-zone-id ${HOSTED_ZONE_ID} \
                      --query "ResourceRecordSets[?Name == '${DOMAIN_NAME}.'].ResourceRecords[0].Value" \
                      --output text)

                    if [ "$LB_DNS" = "None" ]; then
                      echo "Route53 record not found, skipping..."
                      exit 0
                    fi

                    cat > route53-delete.json <<EOF
{
  "Comment": "Delete record from Jenkins",
  "Changes": [{
    "Action": "DELETE",
    "ResourceRecordSet": {
      "Name": "${DOMAIN_NAME}",
      "Type": "CNAME",
      "TTL": 300,
      "ResourceRecords": [{ "Value": "$LB_DNS" }]
    }
  }]
}
EOF

                    aws route53 change-resource-record-sets \
                      --hosted-zone-id ${HOSTED_ZONE_ID} \
                      --change-batch file://route53-delete.json
                '''
            }
        }

        /* -------------------- TERRAFORM DESTROY -------------------- */
        stage('Terraform Destroy') {
            agent { label 'slave' }
            steps {
                dir('sun-kube-cluster/dev') {
                    sh 'terraform destroy -auto-approve -no-color'
                }
            }
        }
    }

    post {
        success {
            echo "ðŸ§¨ Infrastructure destroyed successfully"
        }
        failure {
            echo "âŒ Destroy pipeline failed"
        }
    }
}
